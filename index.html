<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNPåˆ©ç›Šç®¡ç†ãƒ„ãƒ¼ãƒ« (Ver.12 - æœ€çµ‚ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ç‰ˆ)</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .main-header { display: flex; justify-content: space-between; align-items: flex-start; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top:0; width: 100%; }
        h1[contenteditable="true"]:focus { outline: 2px solid #3498db; background-color: #f0f8ff; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        details { border: 1px solid #ddd; border-radius: 5px; margin-left: 20px; flex-shrink: 0; width: 400px; }
        summary { font-weight: bold; cursor: pointer; padding: 15px; background-color: #f9f9f9; }
        .instructions { padding: 0 20px 20px 20px; border-top: 1px solid #ddd; max-height: 400px; overflow-y: auto; }
        .instructions h3 { border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .instructions code { background-color: #eee; padding: 2px 5px; border-radius: 3px; }
        form { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .form-group, .full-width-group { display: flex; flex-direction: column; }
        .full-width-group { grid-column: 1 / -1; }
        fieldset { grid-column: 1 / -1; border: 1px solid #ccc; border-radius: 5px; padding: 15px; }
        legend { font-weight: bold; color: #333; padding: 0 10px; }
        label { margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .monthly-costs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 5px; }
        .form-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 15px; margin-top: 15px; }
        .btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-secondary { background-color: #95a5a6; color: white; }
        .btn-export { background-color: #27ae60; color: white; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; white-space: nowrap; }
        td.memo-cell { white-space: pre-wrap; word-break: break-all; }
        thead th { background-color: #ecf0f1; }
        tfoot th, tfoot td { background-color: #bdc3c7; color: #2c3e50; font-weight: bold; }
        tr.ready-to-port { background-color: #e6ffed !important; }
        .profit { font-weight: bold; color: #27ae60; }
        .loss { font-weight: bold; color: #c0392b; }
        .action-btn { padding: 5px 10px; margin-right: 5px; border-radius: 4px; border: none; color: white; cursor: pointer; }
        .edit-btn { background-color: #2980b9; }
        .delete-btn { background-color: #c0392b; }
        footer { text-align: center; margin-top: 25px; font-size: 14px; color: #555; }
        footer a { color: #3498db; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="container">
        <div class="main-header">
            <h1 id="form-title" contenteditable="true">MNPåˆ©ç›Šç®¡ç†ãƒ„ãƒ¼ãƒ« ğŸ“Š</h1>
            <details>
                <summary>â–¼ ä½¿ã„æ–¹ã¨æ³¨æ„äº‹é …</summary>
                <div class="instructions">
                    <h3>ã¯ã˜ã‚ã« - ãƒ„ãƒ¼ãƒ«ã®3ã¤ã®å¤§ããªç‰¹é•·</h3>
                    <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ä¸€èˆ¬çš„ãªã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚„ã‚¢ãƒ—ãƒªã¨ã¯å°‘ã—é•ã„ã€ä»¥ä¸‹ã®3ã¤ã®å¤§ããªç‰¹é•·ã‚’ã”ç†è§£ã„ãŸã ãã¨ã€ã‚ˆã‚Šå®‰å¿ƒã—ã¦ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
                    <ul>
                        <li><strong>å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§å‹•ä½œ:</strong> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã™ã‚‹å¿…è¦ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½“ã§ã€ã‚ãªãŸã®ãƒ‘ã‚½ã‚³ãƒ³ã®ä¸­ã ã‘ã§å‹•ä½œã—ã¾ã™ã€‚</li>
                        <li><strong>ãƒ‡ãƒ¼ã‚¿ã¯ã‚ãªãŸã®PCã®ä¸­ã«ã ã‘:</strong> å…¥åŠ›ã—ãŸå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ãŠä½¿ã„ã®Webãƒ–ãƒ©ã‚¦ã‚¶ã®å®‰å…¨ãªé ˜åŸŸã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚åˆ¶ä½œè€…ã‚’å«ã‚ã€å¤–éƒ¨ã®èª°ã‹ã«ãƒ‡ãƒ¼ã‚¿ãŒé€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                        <li><strong>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦:</strong> ã‚½ãƒ•ãƒˆã‚’PCã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã ã‘ã§ã€ã™ãã«ä½¿ã„å§‹ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
                    </ul>

                    <h3>å„æ©Ÿèƒ½ã®è©³ã—ã„èª¬æ˜</h3>
                    <p><strong>ã€Œæ–°è¦å¥‘ç´„ã®è¨˜éŒ²ã€ãƒ•ã‚©ãƒ¼ãƒ </strong></p>
                    <ul>
                        <li><strong>ã‚­ãƒ£ãƒªã‚¢:</strong> ä¸»è¦ã‚­ãƒ£ãƒªã‚¢ã¯ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚ã€Œãã®ä»–ã€ã‚’é¸ã¶ã¨ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã€è‡ªç”±ãªã‚­ãƒ£ãƒªã‚¢åï¼ˆæ ¼å®‰SIMãªã©ï¼‰ã‚’å…¥åŠ›ã§ãã¾ã™ã€‚</li>
                        <li><strong>ç´¹ä»‹æ–™ï¼ˆæ”¯æ‰•ã„ï¼‰:</strong> ã“ã‚Œã¯ã‚ãªãŸãŒã€Œå—ã‘å–ã‚‹ã€ã®ã§ã¯ãªãã€ç´¹ä»‹è€…æ§˜ã¸ã€Œæ”¯æ‰•ã†ã€é‡‘é¡ã‚’å…¥åŠ›ã™ã‚‹é …ç›®ã§ã™ã€‚å®Ÿè³ªåˆ©ç›Šã®è¨ˆç®—ã§ã¯è²»ç”¨ï¼ˆãƒã‚¤ãƒŠã‚¹ï¼‰ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚</li>
                        <li><strong>æœˆé¡è²»ç”¨:</strong> 1ï½8ãƒ¶æœˆç›®ã¾ã§ã®ç¶­æŒè²»ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€Œç¶­æŒè²»ç·é¡ã€ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</li>
                    </ul>
                    <p><strong>ã€Œå¥‘ç´„ä¸€è¦§ã€ã®è¦‹æ–¹</strong></p>
                    <ul>
                        <li><strong>å®Ÿè³ªåˆ©ç›Š:</strong> <code>(ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯é¡ + ç«¯æœ«å£²å´é¡) - (ç«¯æœ«è³¼å…¥ä»£ + ç¶­æŒè²»ç·é¡ + ãã®ä»–OPè²»ç”¨ + ç´¹ä»‹æ–™)</code> ã®å¼ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚ãƒ—ãƒ©ã‚¹ãªã‚‰ç·‘è‰²ã€ãƒã‚¤ãƒŠã‚¹ãªã‚‰èµ¤è‰²ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                        <li><strong>è»¢å‡ºå¯èƒ½æ—¥ï¼ˆå‚è€ƒï¼‰:</strong> å¥‘ç´„æ—¥ã‹ã‚‰ã€æ¬¡ã®MNPãŒå¯èƒ½ã«ãªã‚‹ãŠãŠã‚ˆãã®æ—¥ä»˜ã‚’è‡ªå‹•ã§è¡¨ç¤ºã—ã¾ã™ã€‚ï¼ˆè¨ˆç®—å¼: ãƒ‰ã‚³ãƒ¢ã¯182æ—¥å¾Œã€ãã®ä»–ã¯215æ—¥å¾Œï¼‰â€»ã‚ãã¾ã§ç›®å®‰ã§ã™ã€‚</li>
                        <li><strong>ç·‘è‰²ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ:</strong> ã€Œè»¢å‡ºå¯èƒ½æ—¥ï¼ˆå‚è€ƒï¼‰ã€ã‚’éãã¦ãŠã‚Šã€ã‹ã¤ã€Œå¥‘ç´„ä¸­ã€ã®å›ç·šã¯ã€è¡Œå…¨ä½“ãŒç·‘è‰²ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã€ä¸€ç›®ã§åˆ†ã‹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚</li>
                        <li><strong>åˆè¨ˆæ¬„:</strong> ä¸€è¦§ã®æœ€ä¸‹éƒ¨ã«ã¯ã€é‡‘é¡ã«é–¢ã™ã‚‹å…¨ã¦ã®é …ç›®ã®ã€Œç·åˆè¨ˆã€ãŒè‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã€å…¨ä½“ã®åæ”¯çŠ¶æ³ã‚’ç¬æ™‚ã«æŠŠæ¡ã§ãã¾ã™ã€‚</li>
                    </ul>

                    <h3>ã€æœ€é‡è¦ã€‘ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«ã¤ã„ã¦</h3>
                    <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ã‚ãªãŸã®PCã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„é–²è¦§å±¥æ­´ã‚’ã€Œå…¨ã¦æ¶ˆå»ã€ã™ã‚‹ã¨ã€ã“ã®ãƒ„ãƒ¼ãƒ«ã«ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚‚ä¸€ç·’ã«æ¶ˆãˆã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
                    <p><strong>å¤§åˆ‡ãªè¨˜éŒ²ã‚’å®ˆã‚‹ãŸã‚ã€å®šæœŸçš„ã«ã€Œã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸å‡ºåŠ›ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€ã”è‡ªèº«ã®PCã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ç¿’æ…£ã‚’ã¤ã‘ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚</strong></p>
                </div>
            </details>
        </div>

        <h2 id="form-header">ğŸ“ æ–°è¦å¥‘ç´„ã®è¨˜éŒ²</h2>
        <form id="mnp-form">
            <input type="hidden" id="edit-index">
            <div class="form-group"> <label for="keiyaku-date">å¥‘ç´„æ—¥</label> <input type="date" id="keiyaku-date" required> </div>
            <div class="form-group"> <label for="phone-number">é›»è©±ç•ªå·</label> <input type="tel" id="phone-number" placeholder="ä¾‹: 09012345678"> </div>
            <div class="form-group">
                <label for="carrier">ã‚­ãƒ£ãƒªã‚¢</label>
                <select id="carrier" required>
                    <option value="ãƒ‰ã‚³ãƒ¢">ãƒ‰ã‚³ãƒ¢</option> <option value="au/UQ">au/UQ</option> <option value="ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯">ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯</option> <option value="ãƒ¯ã‚¤ãƒ¢ãƒã‚¤ãƒ«">ãƒ¯ã‚¤ãƒ¢ãƒã‚¤ãƒ«</option> <option value="ãã®ä»–">ãã®ä»–</option>
                </select>
                <input type="text" id="carrier-other" style="display:none; margin-top:10px;" placeholder="ã‚­ãƒ£ãƒªã‚¢åã‚’å…¥åŠ›">
            </div>
            <div class="form-group"> <label for="device">ç«¯æœ«</label> <input type="text" id="device" placeholder="ä¾‹: iPhone16"> </div>
            <div class="form-group"> <label for="device-cost">ç«¯æœ«è³¼å…¥ä»£ (å††)</label> <input type="number" id="device-cost" placeholder="0"> </div>
            <div class="form-group"> <label for="cashback-amount">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯é¡ (å††)</label> <input type="number" id="cashback-amount" placeholder="0"> </div>
            <div class="form-group"> <label for="sell-price">ç«¯æœ«å£²å´é¡ (å††)</label> <input type="number" id="sell-price" placeholder="0"> </div>
            <div class="form-group"> <label for="referral-fee">ç´¹ä»‹æ–™ (æ”¯æ‰•ã„)</label> <input type="number" id="referral-fee" placeholder="0"> </div>
            <fieldset> <legend>è²»ç”¨è©³ç´°</legend>
                <div class="form-group"> <label>æœˆé¡è²»ç”¨</label>
                    <div class="monthly-costs">
                        <input type="number" placeholder="1ãƒ¶æœˆç›®" class="monthly-cost"><input type="number" placeholder="2ãƒ¶æœˆç›®" class="monthly-cost">
                        <input type="number" placeholder="3ãƒ¶æœˆç›®" class="monthly-cost"><input type="number" placeholder="4ãƒ¶æœˆç›®" class="monthly-cost">
                        <input type="number" placeholder="5ãƒ¶æœˆç›®" class="monthly-cost"><input type="number" placeholder="6ãƒ¶æœˆç›®" class="monthly-cost">
                        <input type="number" placeholder="7ãƒ¶æœˆç›®" class="monthly-cost"><input type="number" placeholder="8ãƒ¶æœˆç›®" class="monthly-cost">
                    </div>
                    <p><b>ç¶­æŒè²»ç·é¡: <span id="total-maintenance-cost">0</span> å††</b></p>
                </div>
                <div class="form-group"> <label for="option-cost">ãã®ä»–ã‚ªãƒ—ã‚·ãƒ§ãƒ³è²»ç”¨ (å††)</label> <input type="number" id="option-cost" placeholder="0"> </div>
                <div class="form-group"> <label for="option-memo">ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¢</label> <textarea id="option-memo" rows="2"></textarea> </div>
            </fieldset>
            <div class="form-group"> <label for="status">å¥‘ç´„çŠ¶æ³</label> <select id="status"> <option value="å¥‘ç´„ä¸­" selected>å¥‘ç´„ä¸­</option> <option value="è§£ç´„æ¸ˆã¿">è§£ç´„æ¸ˆã¿</option> </select> </div>
            <div class="form-group"> <label for="kaiyaku-date">è§£ç´„æ—¥</label> <input type="date" id="kaiyaku-date"> </div>
            <div class="full-width-group"> <label for="memo">ãƒ¡ãƒ¢</label> <textarea id="memo" rows="3" placeholder="å¥‘ç´„å…¨ä½“ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ãªã©"></textarea> </div>
            <div class="form-actions"> <button type="submit" id="submit-btn" class="btn btn-primary">ç™»éŒ²ã™ã‚‹</button> <button type="button" id="cancel-btn" class="btn btn-secondary" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button> </div>
        </form>

        <h2>ğŸ“ˆ å¥‘ç´„ä¸€è¦§</h2>
        <div class="form-actions" style="justify-content: flex-start;"> <button id="export-btn" class="btn btn-export">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸å‡ºåŠ›</button> </div>
        <div class="table-wrapper">
            <table id="mnp-table">
                <thead> <tr>
                    <th>No.</th><th>å¥‘ç´„æ—¥</th><th>é›»è©±ç•ªå·</th><th>ã‚­ãƒ£ãƒªã‚¢</th><th>ç«¯æœ«</th><th>ç«¯æœ«è³¼å…¥ä»£</th><th>ç¶­æŒè²»ç·é¡</th><th>ãã®ä»–è²»ç”¨</th>
                    <th>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¢</th><th>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯</th><th>ç«¯æœ«å£²å´é¡</th><th>ç´¹ä»‹æ–™(æ”¯æ‰•)</th><th>å®Ÿè³ªåˆ©ç›Š</th><th>è»¢å‡ºå¯èƒ½æ—¥ï¼ˆå‚è€ƒï¼‰</th><th>å¥‘ç´„çŠ¶æ³</th><th>è§£ç´„æ—¥</th><th>ãƒ¡ãƒ¢</th><th>æ“ä½œ</th>
                </tr> </thead>
                <tbody></tbody>
                <tfoot> <tr>
                    <th colspan="5">åˆè¨ˆ</th> <td id="total-device-cost"></td> <td id="total-maintenance-cost-sum"></td> <td id="total-option-cost"></td>
                    <td></td> <td id="total-cashback"></td> <td id="total-sell-price"></td> <td id="total-referral-fee"></td>
                    <td id="total-profit"></td> <td colspan="5"></td>
                </tr> </tfoot>
            </table>
        </div>
    </div>
    <footer>
        åˆ¶ä½œè€…: ã¾ã£ã´ãƒ¼ <a href="https://x.com/mappy_fukugyo" target="_blank" rel="noopener noreferrer">@mappy_fukugyo</a>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mnp-form');
    const tableBody = document.querySelector('#mnp-table tbody');
    const monthlyCostInputs = document.querySelectorAll('.monthly-cost');
    const totalMaintenanceCostSpan = document.getElementById('total-maintenance-cost');
    const editIndexInput = document.getElementById('edit-index');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const formHeader = document.getElementById('form-header');
    const exportBtn = document.getElementById('export-btn');
    const carrierSelect = document.getElementById('carrier');
    const carrierOtherInput = document.getElementById('carrier-other');
    const mainTitle = document.getElementById('form-title');

    // Load saved title
    if (localStorage.getItem('mnpToolTitle')) {
        mainTitle.innerHTML = localStorage.getItem('mnpToolTitle');
    }
    // Save title on edit
    mainTitle.addEventListener('blur', function() {
        localStorage.setItem('mnpToolTitle', this.innerHTML);
    });
    
    let records = JSON.parse(localStorage.getItem('mnpRecordsV12')) || [];

    const getPortOutDate = (d, c) => {
        if (!d) return null;
        const a = new Date(d);
        let daysToAdd = 215; // Default for others
        if (c === 'ãƒ‰ã‚³ãƒ¢') { daysToAdd = 182; }
        a.setDate(a.getDate() + daysToAdd);
        return a;
    };
    const formatDate = (d) => d ? `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}` : '';

    function renderTable() {
        tableBody.innerHTML = '';
        const today = new Date(); today.setHours(0, 0, 0, 0);
        let totals = { dev: 0, maint: 0, opt: 0, cb: 0, sell: 0, ref: 0, prof: 0 };

        records.forEach((rec, idx) => {
            const p = (rec.cashbackAmount || 0) + (rec.sellPrice || 0) - (rec.deviceCost || 0) - (rec.maintenanceCost || 0) - (rec.optionCost || 0) - (rec.referralFee || 0);
            const portOutDate = getPortOutDate(rec.keiyakuDate, rec.carrier);
            const isReady = portOutDate && portOutDate <= today && rec.status === 'å¥‘ç´„ä¸­';

            totals.dev += rec.deviceCost || 0; totals.maint += rec.maintenanceCost || 0; totals.opt += rec.optionCost || 0;
            totals.cb += rec.cashbackAmount || 0; totals.sell += rec.sellPrice || 0; totals.ref += rec.referralFee || 0; totals.prof += p;

            tableBody.innerHTML += `
                <tr class="${isReady ? 'ready-to-port' : ''}">
                    <td>${idx + 1}</td><td>${rec.keiyakuDate}</td><td>${rec.phoneNumber || ''}</td><td>${rec.carrier}</td><td>${rec.device}</td>
                    <td>${(rec.deviceCost || 0).toLocaleString()}å††</td><td>${(rec.maintenanceCost || 0).toLocaleString()}å††</td><td>${(rec.optionCost || 0).toLocaleString()}å††</td>
                    <td class="memo-cell">${rec.optionMemo || ''}</td><td>${(rec.cashbackAmount || 0).toLocaleString()}å††</td><td>${(rec.sellPrice || 0).toLocaleString()}å††</td>
                    <td>${(rec.referralFee || 0).toLocaleString()}å††</td><td class="${p >= 0 ? 'profit' : 'loss'}">${p.toLocaleString()}å††</td>
                    <td>${formatDate(portOutDate) || 'N/A'}</td><td>${rec.status}</td><td>${rec.kaiyakuDate || ''}</td>
                    <td class="memo-cell">${rec.memo || ''}</td>
                    <td><button class="action-btn edit-btn" onclick="editRecord(${idx})">ç·¨é›†</button><button class="action-btn delete-btn" onclick="deleteRecord(${idx})">å‰Šé™¤</button></td>
                </tr>`;
        });
        document.getElementById('total-device-cost').textContent = `${totals.dev.toLocaleString()}å††`;
        document.getElementById('total-maintenance-cost-sum').textContent = `${totals.maint.toLocaleString()}å††`;
        document.getElementById('total-option-cost').textContent = `${totals.opt.toLocaleString()}å††`;
        document.getElementById('total-cashback').textContent = `${totals.cb.toLocaleString()}å††`;
        document.getElementById('total-sell-price').textContent = `${totals.sell.toLocaleString()}å††`;
        document.getElementById('total-referral-fee').textContent = `${totals.ref.toLocaleString()}å††`;
        const totalProfitCell = document.getElementById('total-profit');
        totalProfitCell.textContent = `${totals.prof.toLocaleString()}å††`;
        totalProfitCell.className = totals.prof >= 0 ? 'profit' : 'loss';
    }

    carrierSelect.addEventListener('change', function() {
        carrierOtherInput.style.display = (this.value === 'ãã®ä»–') ? 'block' : 'none';
    });

    window.deleteRecord = (idx) => { if (confirm('ã“ã®è¨˜éŒ²ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { records.splice(idx, 1); saveAndRender(); } };
    window.editRecord = (idx) => {
        const rec = records[idx];
        const standardCarriers = Array.from(carrierSelect.options).map(opt => opt.value);
        editIndexInput.value = idx;
        
        const fieldIds = ['keiyaku-date', 'phone-number', 'device', 'device-cost', 'cashback-amount', 'sell-price', 'referral-fee', 'option-cost', 'option-memo', 'status', 'kaiyaku-date', 'memo'];
        fieldIds.forEach(id => {
            const propName = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
            const el = document.getElementById(id);
            if(el) el.value = rec[propName] === undefined ? '' : rec[propName];
        });
        
        if (standardCarriers.includes(rec.carrier)) {
            carrierSelect.value = rec.carrier;
            carrierOtherInput.style.display = 'none';
            carrierOtherInput.value = '';
        } else {
            carrierSelect.value = 'ãã®ä»–';
            carrierOtherInput.style.display = 'block';
            carrierOtherInput.value = rec.carrier;
        }

        (rec.monthlyCosts || []).forEach((cost, i) => { monthlyCostInputs[i].value = cost || ''; });
        calculateTotalMaintenanceCost();
        formHeader.textContent = `ğŸ“ è¨˜éŒ² No.${idx + 1} ã‚’ç·¨é›†ä¸­...`; submitBtn.textContent = 'æ›´æ–°ã™ã‚‹'; cancelBtn.style.display = 'inline-block';
        window.scrollTo(0, 0);
    };

    const calculateTotalMaintenanceCost = () => { let t = 0; monthlyCostInputs.forEach(i => t += +i.value || 0); totalMaintenanceCostSpan.textContent = t.toLocaleString(); return t; };
    monthlyCostInputs.forEach(input => input.addEventListener('input', calculateTotalMaintenanceCost));

    function resetForm() { form.reset(); editIndexInput.value = ''; monthlyCostInputs.forEach(i => { i.value = ''; }); calculateTotalMaintenanceCost(); carrierOtherInput.style.display = 'none'; formHeader.textContent = 'ğŸ“ æ–°è¦å¥‘ç´„ã®è¨˜éŒ²'; submitBtn.textContent = 'ç™»éŒ²ã™ã‚‹'; cancelBtn.style.display = 'none'; }
    cancelBtn.addEventListener('click', resetForm);

    function saveAndRender() { records.sort((a, b) => new Date(a.keiyakuDate) - new Date(b.keiyakuDate)); localStorage.setItem('mnpRecordsV12', JSON.stringify(records)); renderTable(); }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let finalCarrier = carrierSelect.value;
        if (finalCarrier === 'ãã®ä»–') {
            finalCarrier = carrierOtherInput.value.trim() || 'ãã®ä»–ï¼ˆæœªå…¥åŠ›ï¼‰';
        }
        
        const monthlyCosts = Array.from(monthlyCostInputs).map(i => +i.value || 0);
        const recordData = {
            keiyakuDate: document.getElementById('keiyaku-date').value, phoneNumber: document.getElementById('phone-number').value,
            carrier: finalCarrier, device: document.getElementById('device').value,
            deviceCost: +document.getElementById('device-cost').value || 0, cashbackAmount: +document.getElementById('cashback-amount').value || 0,
            sellPrice: +document.getElementById('sell-price').value || 0, referralFee: +document.getElementById('referral-fee').value || 0,
            maintenanceCost: monthlyCosts.reduce((a, b) => a + b, 0), monthlyCosts: monthlyCosts,
            optionCost: +document.getElementById('option-cost').value || 0, optionMemo: document.getElementById('option-memo').value,
            status: document.getElementById('status').value, kaiyakuDate: document.getElementById('kaiyaku-date').value,
            memo: document.getElementById('memo').value
        };
        const idx = editIndexInput.value;
        if (idx !== '') { records[idx] = recordData; } else { records.push(recordData); }
        saveAndRender(); resetForm();
    });
    
    exportBtn.addEventListener('click', function() {
        if (records.length === 0) return alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        const headers = ["No", "å¥‘ç´„æ—¥", "é›»è©±ç•ªå·", "ã‚­ãƒ£ãƒªã‚¢", "ç«¯æœ«", "ç«¯æœ«è³¼å…¥ä»£", "ç¶­æŒè²»ç·é¡", "ãã®ä»–è²»ç”¨", "ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¢", "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯", "ç«¯æœ«å£²å´é¡", "ç´¹ä»‹æ–™(æ”¯æ‰•)", "å®Ÿè³ªåˆ©ç›Š", "è»¢å‡ºå¯èƒ½æ—¥ï¼ˆå‚è€ƒï¼‰", "å¥‘ç´„çŠ¶æ³", "è§£ç´„æ—¥", "ãƒ¡ãƒ¢"];
        let csvContent = headers.join(",") + "\r\n";
        let totals = { dev: 0, maint: 0, opt: 0, cb: 0, sell: 0, ref: 0, prof: 0 };

        records.forEach((rec, idx) => {
            const p = (rec.cashbackAmount || 0) + (rec.sellPrice || 0) - (rec.deviceCost || 0) - (rec.maintenanceCost || 0) - (rec.optionCost || 0) - (rec.referralFee || 0);
            const portOutDate = getPortOutDate(rec.keiyakuDate, rec.carrier);
            totals.dev += rec.deviceCost || 0; totals.maint += rec.maintenanceCost || 0; totals.opt += rec.optionCost || 0;
            totals.cb += rec.cashbackAmount || 0; totals.sell += rec.sellPrice || 0; totals.ref += rec.referralFee || 0; totals.prof += p;
            const row = [idx + 1, rec.keiyakuDate, rec.phoneNumber, rec.carrier, rec.device, rec.deviceCost, rec.maintenanceCost, rec.optionCost, `"${rec.optionMemo || ''}"`, rec.cashbackAmount, rec.sellPrice, rec.referralFee, p, formatDate(portOutDate) || '', rec.status, rec.kaiyakuDate, `"${rec.memo || ''}"`];
            csvContent += row.join(",") + "\r\n";
        });
        
        csvContent += "\r\n";
        const totalRow = ["åˆè¨ˆ", "", "", "", "", totals.dev, totals.maint, totals.opt, "", totals.cb, totals.sell, totals.ref, totals.prof, "", "", "", ""];
        csvContent += totalRow.join(",") + "\r\n";

        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `mnp_records_${formatDate(new Date())}.csv`;
        link.click();
    });

    renderTable();
});
</script>
</body>
</html>