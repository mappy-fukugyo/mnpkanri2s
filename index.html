<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNP利益管理ツール (Ver.12 - 最終デザイン調整版)</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .main-header { display: flex; justify-content: space-between; align-items: flex-start; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top:0; width: 100%; }
        h1[contenteditable="true"]:focus { outline: 2px solid #3498db; background-color: #f0f8ff; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        details { border: 1px solid #ddd; border-radius: 5px; margin-left: 20px; flex-shrink: 0; width: 400px; }
        summary { font-weight: bold; cursor: pointer; padding: 15px; background-color: #f9f9f9; }
        .instructions { padding: 0 20px 20px 20px; border-top: 1px solid #ddd; max-height: 400px; overflow-y: auto; }
        .instructions h3 { border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .instructions code { background-color: #eee; padding: 2px 5px; border-radius: 3px; }
        form { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .form-group, .full-width-group { display: flex; flex-direction: column; }
        .full-width-group { grid-column: 1 / -1; }
        fieldset { grid-column: 1 / -1; border: 1px solid #ccc; border-radius: 5px; padding: 15px; }
        legend { font-weight: bold; color: #333; padding: 0 10px; }
        label { margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .monthly-costs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 5px; }
        .form-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 15px; margin-top: 15px; }
        .btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-secondary { background-color: #95a5a6; color: white; }
        .btn-export { background-color: #27ae60; color: white; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; white-space: nowrap; }
        td.memo-cell { white-space: pre-wrap; word-break: break-all; }
        thead th { background-color: #ecf0f1; }
        tfoot th, tfoot td { background-color: #bdc3c7; color: #2c3e50; font-weight: bold; }
        tr.ready-to-port { background-color: #e6ffed !important; }
        .profit { font-weight: bold; color: #27ae60; }
        .loss { font-weight: bold; color: #c0392b; }
        .action-btn { padding: 5px 10px; margin-right: 5px; border-radius: 4px; border: none; color: white; cursor: pointer; }
        .edit-btn { background-color: #2980b9; }
        .delete-btn { background-color: #c0392b; }
        footer { text-align: center; margin-top: 25px; font-size: 14px; color: #555; }
        footer a { color: #3498db; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="container">
        <div class="main-header">
            <h1 id="form-title" contenteditable="true">MNP利益管理ツール 📊</h1>
            <details>
                <summary>▼ 使い方と注意事項</summary>
                <div class="instructions">
                    <h3>はじめに - ツールの3つの大きな特長</h3>
                    <p>このツールは、一般的なウェブサイトやアプリとは少し違い、以下の3つの大きな特長をご理解いただくと、より安心してご利用いただけます。</p>
                    <ul>
                        <li><strong>完全オフラインで動作:</strong> インターネットに接続する必要は一切ありません。このファイル単体で、あなたのパソコンの中だけで動作します。</li>
                        <li><strong>データはあなたのPCの中にだけ:</strong> 入力した全てのデータは、お使いのWebブラウザの安全な領域にのみ保存されます。制作者を含め、外部の誰かにデータが送信されることは絶対にありません。</li>
                        <li><strong>インストール不要:</strong> ソフトをPCにインストールする必要はありません。このファイルをダブルクリックするだけで、すぐに使い始めることができます。</li>
                    </ul>

                    <h3>各機能の詳しい説明</h3>
                    <p><strong>「新規契約の記録」フォーム</strong></p>
                    <ul>
                        <li><strong>キャリア:</strong> 主要キャリアはプルダウンから選択できます。「その他」を選ぶとテキストボックスが表示され、自由なキャリア名（格安SIMなど）を入力できます。</li>
                        <li><strong>紹介料（支払い）:</strong> これはあなたが「受け取る」のではなく、紹介者様へ「支払う」金額を入力する項目です。実質利益の計算では費用（マイナス）として扱われます。</li>
                        <li><strong>月額費用:</strong> 1～8ヶ月目までの維持費を入力すると「維持費総額」がリアルタイムで自動計算されます。</li>
                    </ul>
                    <p><strong>「契約一覧」の見方</strong></p>
                    <ul>
                        <li><strong>実質利益:</strong> <code>(キャッシュバック額 + 端末売却額) - (端末購入代 + 維持費総額 + その他OP費用 + 紹介料)</code> の式で自動計算されます。プラスなら緑色、マイナスなら赤色で表示されます。</li>
                        <li><strong>転出可能日（参考）:</strong> 契約日から、次のMNPが可能になるおおよその日付を自動で表示します。（計算式: ドコモは182日後、その他は215日後）※あくまで目安です。</li>
                        <li><strong>緑色のハイライト:</strong> 「転出可能日（参考）」を過ぎており、かつ「契約中」の回線は、行全体が緑色にハイライトされ、一目で分かるようになっています。</li>
                        <li><strong>合計欄:</strong> 一覧の最下部には、金額に関する全ての項目の「総合計」が自動で表示され、全体の収支状況を瞬時に把握できます。</li>
                    </ul>

                    <h3>【最重要】データのバックアップについて</h3>
                    <p>このツールのデータは、あなたのPCのブラウザ内に保存されています。ブラウザのキャッシュや閲覧履歴を「全て消去」すると、このツールに保存したデータも一緒に消えてしまう可能性があります。</p>
                    <p><strong>大切な記録を守るため、定期的に「スプレッドシートへ出力」ボタンを押し、ご自身のPCにデータをバックアップする習慣をつけることを強く推奨します。</strong></p>
                </div>
            </details>
        </div>

        <h2 id="form-header">📝 新規契約の記録</h2>
        <form id="mnp-form">
            <input type="hidden" id="edit-index">
            <div class="form-group"> <label for="keiyaku-date">契約日</label> <input type="date" id="keiyaku-date" required> </div>
            <div class="form-group"> <label for="phone-number">電話番号</label> <input type="tel" id="phone-number" placeholder="例: 09012345678"> </div>
            <div class="form-group">
                <label for="carrier">キャリア</label>
                <select id="carrier" required>
                    <option value="ドコモ">ドコモ</option> <option value="au/UQ">au/UQ</option> <option value="ソフトバンク">ソフトバンク</option> <option value="ワイモバイル">ワイモバイル</option> <option value="その他">その他</option>
                </select>
                <input type="text" id="carrier-other" style="display:none; margin-top:10px;" placeholder="キャリア名を入力">
            </div>
            <div class="form-group"> <label for="device">端末</label> <input type="text" id="device" placeholder="例: iPhone16"> </div>
            <div class="form-group"> <label for="device-cost">端末購入代 (円)</label> <input type="number" id="device-cost" placeholder="0"> </div>
            <div class="form-group"> <label for="cashback-amount">キャッシュバック額 (円)</label> <input type="number" id="cashback-amount" placeholder="0"> </div>
            <div class="form-group"> <label for="sell-price">端末売却額 (円)</label> <input type="number" id="sell-price" placeholder="0"> </div>
            <div class="form-group"> <label for="referral-fee">紹介料 (支払い)</label> <input type="number" id="referral-fee" placeholder="0"> </div>
            <fieldset> <legend>費用詳細</legend>
                <div class="form-group"> <label>月額費用</label>
                    <div class="monthly-costs">
                        <input type="number" placeholder="1ヶ月目" class="monthly-cost"><input type="number" placeholder="2ヶ月目" class="monthly-cost">
                        <input type="number" placeholder="3ヶ月目" class="monthly-cost"><input type="number" placeholder="4ヶ月目" class="monthly-cost">
                        <input type="number" placeholder="5ヶ月目" class="monthly-cost"><input type="number" placeholder="6ヶ月目" class="monthly-cost">
                        <input type="number" placeholder="7ヶ月目" class="monthly-cost"><input type="number" placeholder="8ヶ月目" class="monthly-cost">
                    </div>
                    <p><b>維持費総額: <span id="total-maintenance-cost">0</span> 円</b></p>
                </div>
                <div class="form-group"> <label for="option-cost">その他オプション費用 (円)</label> <input type="number" id="option-cost" placeholder="0"> </div>
                <div class="form-group"> <label for="option-memo">オプションメモ</label> <textarea id="option-memo" rows="2"></textarea> </div>
            </fieldset>
            <div class="form-group"> <label for="status">契約状況</label> <select id="status"> <option value="契約中" selected>契約中</option> <option value="解約済み">解約済み</option> </select> </div>
            <div class="form-group"> <label for="kaiyaku-date">解約日</label> <input type="date" id="kaiyaku-date"> </div>
            <div class="full-width-group"> <label for="memo">メモ</label> <textarea id="memo" rows="3" placeholder="契約全体に関するメモなど"></textarea> </div>
            <div class="form-actions"> <button type="submit" id="submit-btn" class="btn btn-primary">登録する</button> <button type="button" id="cancel-btn" class="btn btn-secondary" style="display:none;">キャンセル</button> </div>
        </form>

        <h2>📈 契約一覧</h2>
        <div class="form-actions" style="justify-content: flex-start;"> <button id="export-btn" class="btn btn-export">スプレッドシートへ出力</button> </div>
        <div class="table-wrapper">
            <table id="mnp-table">
                <thead> <tr>
                    <th>No.</th><th>契約日</th><th>電話番号</th><th>キャリア</th><th>端末</th><th>端末購入代</th><th>維持費総額</th><th>その他費用</th>
                    <th>オプションメモ</th><th>キャッシュバック</th><th>端末売却額</th><th>紹介料(支払)</th><th>実質利益</th><th>転出可能日（参考）</th><th>契約状況</th><th>解約日</th><th>メモ</th><th>操作</th>
                </tr> </thead>
                <tbody></tbody>
                <tfoot> <tr>
                    <th colspan="5">合計</th> <td id="total-device-cost"></td> <td id="total-maintenance-cost-sum"></td> <td id="total-option-cost"></td>
                    <td></td> <td id="total-cashback"></td> <td id="total-sell-price"></td> <td id="total-referral-fee"></td>
                    <td id="total-profit"></td> <td colspan="5"></td>
                </tr> </tfoot>
            </table>
        </div>
    </div>
    <footer>
        制作者: まっぴー <a href="https://x.com/mappy_fukugyo" target="_blank" rel="noopener noreferrer">@mappy_fukugyo</a>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mnp-form');
    const tableBody = document.querySelector('#mnp-table tbody');
    const monthlyCostInputs = document.querySelectorAll('.monthly-cost');
    const totalMaintenanceCostSpan = document.getElementById('total-maintenance-cost');
    const editIndexInput = document.getElementById('edit-index');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const formHeader = document.getElementById('form-header');
    const exportBtn = document.getElementById('export-btn');
    const carrierSelect = document.getElementById('carrier');
    const carrierOtherInput = document.getElementById('carrier-other');
    const mainTitle = document.getElementById('form-title');

    // Load saved title
    if (localStorage.getItem('mnpToolTitle')) {
        mainTitle.innerHTML = localStorage.getItem('mnpToolTitle');
    }
    // Save title on edit
    mainTitle.addEventListener('blur', function() {
        localStorage.setItem('mnpToolTitle', this.innerHTML);
    });
    
    let records = JSON.parse(localStorage.getItem('mnpRecordsV12')) || [];

    const getPortOutDate = (d, c) => {
        if (!d) return null;
        const a = new Date(d);
        let daysToAdd = 215; // Default for others
        if (c === 'ドコモ') { daysToAdd = 182; }
        a.setDate(a.getDate() + daysToAdd);
        return a;
    };
    const formatDate = (d) => d ? `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}` : '';

    function renderTable() {
        tableBody.innerHTML = '';
        const today = new Date(); today.setHours(0, 0, 0, 0);
        let totals = { dev: 0, maint: 0, opt: 0, cb: 0, sell: 0, ref: 0, prof: 0 };

        records.forEach((rec, idx) => {
            const p = (rec.cashbackAmount || 0) + (rec.sellPrice || 0) - (rec.deviceCost || 0) - (rec.maintenanceCost || 0) - (rec.optionCost || 0) - (rec.referralFee || 0);
            const portOutDate = getPortOutDate(rec.keiyakuDate, rec.carrier);
            const isReady = portOutDate && portOutDate <= today && rec.status === '契約中';

            totals.dev += rec.deviceCost || 0; totals.maint += rec.maintenanceCost || 0; totals.opt += rec.optionCost || 0;
            totals.cb += rec.cashbackAmount || 0; totals.sell += rec.sellPrice || 0; totals.ref += rec.referralFee || 0; totals.prof += p;

            tableBody.innerHTML += `
                <tr class="${isReady ? 'ready-to-port' : ''}">
                    <td>${idx + 1}</td><td>${rec.keiyakuDate}</td><td>${rec.phoneNumber || ''}</td><td>${rec.carrier}</td><td>${rec.device}</td>
                    <td>${(rec.deviceCost || 0).toLocaleString()}円</td><td>${(rec.maintenanceCost || 0).toLocaleString()}円</td><td>${(rec.optionCost || 0).toLocaleString()}円</td>
                    <td class="memo-cell">${rec.optionMemo || ''}</td><td>${(rec.cashbackAmount || 0).toLocaleString()}円</td><td>${(rec.sellPrice || 0).toLocaleString()}円</td>
                    <td>${(rec.referralFee || 0).toLocaleString()}円</td><td class="${p >= 0 ? 'profit' : 'loss'}">${p.toLocaleString()}円</td>
                    <td>${formatDate(portOutDate) || 'N/A'}</td><td>${rec.status}</td><td>${rec.kaiyakuDate || ''}</td>
                    <td class="memo-cell">${rec.memo || ''}</td>
                    <td><button class="action-btn edit-btn" onclick="editRecord(${idx})">編集</button><button class="action-btn delete-btn" onclick="deleteRecord(${idx})">削除</button></td>
                </tr>`;
        });
        document.getElementById('total-device-cost').textContent = `${totals.dev.toLocaleString()}円`;
        document.getElementById('total-maintenance-cost-sum').textContent = `${totals.maint.toLocaleString()}円`;
        document.getElementById('total-option-cost').textContent = `${totals.opt.toLocaleString()}円`;
        document.getElementById('total-cashback').textContent = `${totals.cb.toLocaleString()}円`;
        document.getElementById('total-sell-price').textContent = `${totals.sell.toLocaleString()}円`;
        document.getElementById('total-referral-fee').textContent = `${totals.ref.toLocaleString()}円`;
        const totalProfitCell = document.getElementById('total-profit');
        totalProfitCell.textContent = `${totals.prof.toLocaleString()}円`;
        totalProfitCell.className = totals.prof >= 0 ? 'profit' : 'loss';
    }

    carrierSelect.addEventListener('change', function() {
        carrierOtherInput.style.display = (this.value === 'その他') ? 'block' : 'none';
    });

    window.deleteRecord = (idx) => { if (confirm('この記録を本当に削除しますか？')) { records.splice(idx, 1); saveAndRender(); } };
    window.editRecord = (idx) => {
        const rec = records[idx];
        const standardCarriers = Array.from(carrierSelect.options).map(opt => opt.value);
        editIndexInput.value = idx;
        
        const fieldIds = ['keiyaku-date', 'phone-number', 'device', 'device-cost', 'cashback-amount', 'sell-price', 'referral-fee', 'option-cost', 'option-memo', 'status', 'kaiyaku-date', 'memo'];
        fieldIds.forEach(id => {
            const propName = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
            const el = document.getElementById(id);
            if(el) el.value = rec[propName] === undefined ? '' : rec[propName];
        });
        
        if (standardCarriers.includes(rec.carrier)) {
            carrierSelect.value = rec.carrier;
            carrierOtherInput.style.display = 'none';
            carrierOtherInput.value = '';
        } else {
            carrierSelect.value = 'その他';
            carrierOtherInput.style.display = 'block';
            carrierOtherInput.value = rec.carrier;
        }

        (rec.monthlyCosts || []).forEach((cost, i) => { monthlyCostInputs[i].value = cost || ''; });
        calculateTotalMaintenanceCost();
        formHeader.textContent = `📝 記録 No.${idx + 1} を編集中...`; submitBtn.textContent = '更新する'; cancelBtn.style.display = 'inline-block';
        window.scrollTo(0, 0);
    };

    const calculateTotalMaintenanceCost = () => { let t = 0; monthlyCostInputs.forEach(i => t += +i.value || 0); totalMaintenanceCostSpan.textContent = t.toLocaleString(); return t; };
    monthlyCostInputs.forEach(input => input.addEventListener('input', calculateTotalMaintenanceCost));

    function resetForm() { form.reset(); editIndexInput.value = ''; monthlyCostInputs.forEach(i => { i.value = ''; }); calculateTotalMaintenanceCost(); carrierOtherInput.style.display = 'none'; formHeader.textContent = '📝 新規契約の記録'; submitBtn.textContent = '登録する'; cancelBtn.style.display = 'none'; }
    cancelBtn.addEventListener('click', resetForm);

    function saveAndRender() { records.sort((a, b) => new Date(a.keiyakuDate) - new Date(b.keiyakuDate)); localStorage.setItem('mnpRecordsV12', JSON.stringify(records)); renderTable(); }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let finalCarrier = carrierSelect.value;
        if (finalCarrier === 'その他') {
            finalCarrier = carrierOtherInput.value.trim() || 'その他（未入力）';
        }
        
        const monthlyCosts = Array.from(monthlyCostInputs).map(i => +i.value || 0);
        const recordData = {
            keiyakuDate: document.getElementById('keiyaku-date').value, phoneNumber: document.getElementById('phone-number').value,
            carrier: finalCarrier, device: document.getElementById('device').value,
            deviceCost: +document.getElementById('device-cost').value || 0, cashbackAmount: +document.getElementById('cashback-amount').value || 0,
            sellPrice: +document.getElementById('sell-price').value || 0, referralFee: +document.getElementById('referral-fee').value || 0,
            maintenanceCost: monthlyCosts.reduce((a, b) => a + b, 0), monthlyCosts: monthlyCosts,
            optionCost: +document.getElementById('option-cost').value || 0, optionMemo: document.getElementById('option-memo').value,
            status: document.getElementById('status').value, kaiyakuDate: document.getElementById('kaiyaku-date').value,
            memo: document.getElementById('memo').value
        };
        const idx = editIndexInput.value;
        if (idx !== '') { records[idx] = recordData; } else { records.push(recordData); }
        saveAndRender(); resetForm();
    });
    
    exportBtn.addEventListener('click', function() {
        if (records.length === 0) return alert('エクスポートするデータがありません。');
        const headers = ["No", "契約日", "電話番号", "キャリア", "端末", "端末購入代", "維持費総額", "その他費用", "オプションメモ", "キャッシュバック", "端末売却額", "紹介料(支払)", "実質利益", "転出可能日（参考）", "契約状況", "解約日", "メモ"];
        let csvContent = headers.join(",") + "\r\n";
        let totals = { dev: 0, maint: 0, opt: 0, cb: 0, sell: 0, ref: 0, prof: 0 };

        records.forEach((rec, idx) => {
            const p = (rec.cashbackAmount || 0) + (rec.sellPrice || 0) - (rec.deviceCost || 0) - (rec.maintenanceCost || 0) - (rec.optionCost || 0) - (rec.referralFee || 0);
            const portOutDate = getPortOutDate(rec.keiyakuDate, rec.carrier);
            totals.dev += rec.deviceCost || 0; totals.maint += rec.maintenanceCost || 0; totals.opt += rec.optionCost || 0;
            totals.cb += rec.cashbackAmount || 0; totals.sell += rec.sellPrice || 0; totals.ref += rec.referralFee || 0; totals.prof += p;
            const row = [idx + 1, rec.keiyakuDate, rec.phoneNumber, rec.carrier, rec.device, rec.deviceCost, rec.maintenanceCost, rec.optionCost, `"${rec.optionMemo || ''}"`, rec.cashbackAmount, rec.sellPrice, rec.referralFee, p, formatDate(portOutDate) || '', rec.status, rec.kaiyakuDate, `"${rec.memo || ''}"`];
            csvContent += row.join(",") + "\r\n";
        });
        
        csvContent += "\r\n";
        const totalRow = ["合計", "", "", "", "", totals.dev, totals.maint, totals.opt, "", totals.cb, totals.sell, totals.ref, totals.prof, "", "", "", ""];
        csvContent += totalRow.join(",") + "\r\n";

        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `mnp_records_${formatDate(new Date())}.csv`;
        link.click();
    });

    renderTable();
});
</script>
</body>
</html>